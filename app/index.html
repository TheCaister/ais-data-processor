<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap, fonts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css"
        integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"
        integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
        integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
        integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
        crossorigin=""></script>

    <title>AIS Stream</title>

    <style>
        #map {
            position: absolute;
            left: 0;
            right: 0;
            height: 500px;
            width: 500px;
            z-index: 999;
        }
    </style>
</head>

<body>

    <!-- Navbar for aesthetics -->
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a href="#" class="navbar-brand"> Real-Time AIS Stream</a>
        </div>
    </nav>

    <!-- Button to generate and display token -->
    <div>
        <div>
            <button id="token-button">Get Token</button>
            <p id="token">Token:</p>
        </div>
        <button id="ais-button">Starting receiving AIS Stream (Get the token first!!)</button>
    </div>

    <!-- Leaflet map -->
    <div id="map"></div>

    <!-- List of AIS data -->
    <div class="container">
        <div id="aisStream"></div>
    </div>

    <!-- Importing Socket.io library from CDN -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.2/socket.io.js"
        integrity="sha512-VJ6+sp2E5rFQk05caiXXzQd1wBABpjEj1r5kMiLmGAAgwPItw1YpqsCCBtq8Yr1x6C49/mTpRdXtq8O2RcZhlQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script> -->
    <script src="/socket.io/socket.io.js"></script>
    <script>

        // Will flip to true as soon as the first connection is established.
        var connectedOnce = false;

        // This is the element that will display AIS data in blocks on the web page.
        const aisStream = document.getElementById('aisStream');

        const socket = io();

        // Setting up a layer group for AIS data and a mock layer group for ADS-B data.
        var aisDataList = L.layerGroup();
        var adsbDataList = L.layerGroup();

        // Listen for when we connect
        socket.on('connect', () => {


            console.log("Connected!");

            if (connectedOnce) {
                socket.emit('ais_req');
            }

            connectedOnce = true;
        })

        // --------------- SETTING UP BUTTONS -------------------------

        const tokenButton = document.getElementById('token-button');
        const aisButton = document.getElementById('ais-button');

        tokenButton.onclick = () => {
            // Ask the server to generate a token.
            console.log('Sending token request...');
            socket.emit('token');
        };

        aisButton.onclick = () => {
            // Ask the server to generate a token.
            console.log('Sending AIS stream request...');
            socket.emit('ais_req');
        };

        // socket.on("disconnect", () => {
        //     console.log('Disconnected: ', socket.id); // undefined
        // });




        // --------------- SETTING UP BUTTONS -------------------------

        // --------------- DISPLAYING TOKEN ---------------------------

        const token = document.getElementById('token');
        // token.innerHTML = 'Token generated.';

        socket.on("display_token", (tokenContent) => {

            // token.innerHTML = token;
            token.textContent = tokenContent;
            // token.innerHTML = 'Token generated.';
        })


        // --------------- DISPLAYING TOKEN ---------------------------

        // Set view with latitude and longitude
        var map = L.map('map').setView([0, 0], 1);

        // Add tile layer
        // Using raster tiles in this case.
        L.tileLayer('https://api.maptiler.com/maps/streets-v2/256/{z}/{x}/{y}.png?key=EKQLq5weIwI9G1UJd5RT', {
            attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>',

            crossOrigin: true
        }).addTo(map);

        var planeIcon = L.icon({
            iconUrl: 'https://image.similarpng.com/very-thumbnail/2021/10/Realistic-plane-isolated-on-transparent-background-PNG.png',
            iconSize: [24, 18],
            iconAnchor: [22, 94],
            // Corresponding point for the popup to the icon
            popupAnchor: [12, -90]
        })

        var shipIcon = L.icon({
            iconUrl: 'https://w7.pngwing.com/pngs/260/825/png-transparent-sailing-ship-caravel-man-of-war-full-rigged-pinnace-sailing-vehicle-transport-dromon.png',
            iconSize: [24, 18],
            iconAnchor: [22, 94],
            // Corresponding point for the popup to the icon
            popupAnchor: [12, -90]
        })

        var marker = null;

        var overlays = {
            "Ships": aisDataList,
            "Planes": adsbDataList
        };

        var layerControl = L.control.layers(null, overlays).addTo(map);



        // Listening to the custom made 'ais' event.
        socket.on('aiss', (ais) => {

            const dataNum = 10;

            // Setting a limit on how many can be displayed
            // if (aisStream.childElementCount > dataNum) {
            //     while (aisStream.firstChild) {
            //         myNode.removeChild(aisStream.lastChild);
            //     }
            // }

            // var marker = L.marker([ais.latitude, ais.longitude], { icon: leafletIcon }).addTo(map);
            // marker.setLatLng(ais.latitude, ais.longitude);

            // if (marker !== null) {
            //     map.removeLayer(marker);
            // }

            // marker = L.marker([ais.latitude, ais.longitude], { icon: leafletIcon }).addTo(map);

            // ------------- LAYERS GROUP -------------------

            // Random boolean variable
            var isPlane = Math.random() < 0.5;

            const iconLimit = 50;

            // Reducing the amount of icons plotted.
            if (aisDataList.getLayers().length > iconLimit) {
                aisDataList.clearLayers();
            }

            if (adsbDataList.getLayers().length > iconLimit) {
                adsbDataList.clearLayers();
            }

            // marker = L.marker([ais.latitude, ais.longitude], { icon: leafletIcon }).addTo(map);

            // Add to different group based on isPlane.
            if (isPlane) {
                marker = L.marker([ais.latitude, ais.longitude], { icon: planeIcon });
                adsbDataList.addLayer(marker);
            }
            else {
                marker = L.marker([ais.latitude, ais.longitude], { icon: shipIcon });
                aisDataList.addLayer(marker);
            }


            // ------------- LAYERS GROUP -------------------


            console.log(ais);

            // Creating a HTML element to display AIS data.
            const aisElement = document.createElement('div');

            // Two classes. Margin on top and bottom.
            aisElement.className = 'card my-4';

            aisElement.innerHTML = `
                <div class="card-body">
                    <h5 class="card-title">MMSI: ${ais.mmsi}</h5>
                    <h6 class="card-subtitle" mb-2 text-muted>Type: ${ais.type}</h6>
                    <h6 class="card-subtitle" mb-2 text-muted>Message Type: ${ais.messageType}</h6>
                    <h6 class="card-subtitle" mb-2 text-muted>AIS Class: ${ais.aisClass}</h6>
                    <h6 class="card-subtitle" mb-2 text-muted>Altitude: ${ais.altitude}</h6>
                    <h6 class="card-subtitle" mb-2 text-muted>Latitude: ${ais.latitude}</h6>
                    <h6 class="card-subtitle" mb-2 text-muted>Longitude: ${ais.longitude}</h6>
                    <h6 class="card-subtitle" mb-2 text-muted>Navigational Status: ${ais.navigationalStatus}</h6>
                    <h6 class="card-subtitle" mb-2 text-muted>COG: ${ais.courseOverGround}</h6>
                    <h6 class="card-subtitle" mb-2 text-muted>SOG: ${ais.speedOverGround}</h6>
                    <h6 class="card-subtitle" mb-2 text-muted>ROT: ${ais.rateOfTurn}</h6>
                    <h6 class="card-subtitle" mb-2 text-muted>True Heading: ${ais.trueHeading}</h6>
                    <h6 class="card-subtitle" mb-2 text-muted>Message Time: ${ais.msgtime}</h6>
                </div>
                `;

            aisStream.appendChild(aisElement);
        });

        // Listening to the custom made 'ais' event.
        socket.on('ais', (ais) => {

            const dataNum = 5;

            // Setting a limit on how many can be displayed
            if (aisStream.childElementCount > dataNum) {
                // while (aisStream.firstChild) {
                //     aisStream.removeChild(aisStream.lastChild);
                // }
                aisStream.removeChild(aisStream.firstChild);

            }

            // ------------- LAYERS GROUP -------------------

            // Random boolean variable
            var isPlane = Math.random() < 0.5;

            const iconLimit = 10;

            // Reducing the amount of icons plotted.
            if (aisDataList.getLayers().length > iconLimit) {
                aisDataList.clearLayers();
            }

            if (adsbDataList.getLayers().length > iconLimit) {
                adsbDataList.clearLayers();
            }

            // marker = L.marker([ais.latitude, ais.longitude], { icon: leafletIcon }).addTo(map);

            // Add to different group based on isPlane.
            if (isPlane) {
                marker = L.marker([ais.latitude, ais.longitude], { icon: planeIcon });
                adsbDataList.addLayer(marker);
            }
            else {
                marker = L.marker([ais.latitude, ais.longitude], { icon: shipIcon });
                aisDataList.addLayer(marker);
            }


            // ------------- LAYERS GROUP -------------------


            console.log(ais);

            // Creating a HTML element to display AIS data.
            const aisElement = document.createElement('div');

            // Two classes. Margin on top and bottom.
            aisElement.className = 'card my-4';

            aisElement.innerHTML = `
    <div class="card-body">
        <h5 class="card-title">MMSI: ${ais.mmsi}</h5>
        <h6 class="card-subtitle" mb-2 text-muted>Type: ${ais.type}</h6>
        <h6 class="card-subtitle" mb-2 text-muted>Message Type: ${ais.messageType}</h6>
        <h6 class="card-subtitle" mb-2 text-muted>AIS Class: ${ais.aisClass}</h6>
        <h6 class="card-subtitle" mb-2 text-muted>Altitude: ${ais.altitude}</h6>
        <h6 class="card-subtitle" mb-2 text-muted>Latitude: ${ais.latitude}</h6>
        <h6 class="card-subtitle" mb-2 text-muted>Longitude: ${ais.longitude}</h6>
        <h6 class="card-subtitle" mb-2 text-muted>Navigational Status: ${ais.navigationalStatus}</h6>
        <h6 class="card-subtitle" mb-2 text-muted>COG: ${ais.courseOverGround}</h6>
        <h6 class="card-subtitle" mb-2 text-muted>SOG: ${ais.speedOverGround}</h6>
        <h6 class="card-subtitle" mb-2 text-muted>ROT: ${ais.rateOfTurn}</h6>
        <h6 class="card-subtitle" mb-2 text-muted>True Heading: ${ais.trueHeading}</h6>
        <h6 class="card-subtitle" mb-2 text-muted>Message Time: ${ais.msgtime}</h6>
    </div>
    `;

            aisStream.appendChild(aisElement);
        });

    </script>
</body>

</html>